<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <meta name="generator" content="Hugo 0.37.1" />

  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>HSVS-HTTP全流量可视化系统</title>

  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml" title="HSVS-HTTP全流量可视化系统" />

</head>
<body>

<div class="sidebar">
    <div class="navigation">
        <div align="center">
    <img src="https://s1.ax1x.com/2018/04/02/CSA2sf.png" height=100 width=100>
</div>

        <h1 class="site-title"><a href="">HSVS-HTTP全流量可视化系统</a></h1>


        <nav class="internal">
            <ul>
    
        
            
    <li>
        <a href="#introduce">简介</a>
        <ul>
            
            
                <li><a href="#feature">功能特点</a></li>
            
        </ul>
    </li>



        
            
    <li>
        <a href="#install">安装</a>
        <ul>
            
            
                <li><a href="#install_standalone">单机版</a></li>
            
                <li><a href="#cluster_intra">集群-内网版*</a></li>
            
                <li><a href="#install_pub">集群-公网版*</a></li>
            
        </ul>
    </li>



        
            
    <li>
        <a href="#usage">使用</a>
        <ul>
            
            
                <li><a href="#work">业务</a></li>
            
                <li><a href="#security">安全</a></li>
            
                <li><a href="#ana_interface">分析接口</a></li>
            
        </ul>
    </li>



        
            
    <li>
        <a href="#appendix">附录</a>
        <ul>
            
            
                <li><a href="#dict">数据字典</a></li>
            
                <li><a href="#FAQ">FAQ</a></li>
            
                <li><a href="#contact">联系我们</a></li>
            
        </ul>
    </li>



        
    
</ul>

        </nav>

        <nav class="external">
            <div class="external-title">河马安全团队</div>
            
            <ul id="shortcuts">
                
                <li>
                    <a href="" target="_blank" rel="noopener">HOME</a>
                </li>
                
            </ul>
            
        </nav>
    </div>

    <div class="version">
            generated on Apr 2, 2018
    </div>
</div>

<div class="content">
    
        
            
    <section class="page" id="introduce">
    <h1>
        <a href="#introduce">简介</a>
    </h1>
    <div class="content">
        <p>本项目名称为HSVS(HTTP STREAM VISUALIZATION SYSTEM), HTTP流量可视化系统。 本项目名称为HSVS，并没有直接称呼为流量分析系统；目的是将分析部分开放出来，让使用者使用自己的方法，自由的进行分析。</p>

<p>HTTP全流量分析目前已经在各大厂里比较普及了(BAT，携程，网易&hellip;)。 HTTP全流量分析相比之前单纯的WEB日志多了详细的请求头，完整的相应体，能分析出更多有用的东西。特别是随着<a href="https://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a>的流行，传统的WEB日志已经拿不到请求的真实响应(status code)了。</p>

<p>全流量分析涉及到一定的底层开发，还有分析系统开发，对于小企业有一定门槛，本项目旨在消除此门槛，让大家都能做到自由的获取HTTP全流量数据。 笔者所从事的信息安全行业对于HTTP全流量分析需求比较迫切。 HTTP流量分析既可以发现信息安全领域的问题，也可以在业务风控领域有所建树。 从信息安全的发展趋势来看，目前是从信息安全往企业安全和内容安全发展。 而HTTP全流量分析成为了企业安全和内容安全的重要组成部分。</p>

<div class="block note">
    <p>在使用本系统前建议了解的知识<br />
1. <a href="https://www.elastic.co">ELK</a><br />
2. <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html">HTTP规范</a><br />
3. 建议掌握一些常见的kibana搜索知识(简单使用)<br />
4. 掌握常用分析算法和分析程序（例如使用spark进行分析）</p>

</div>


    </div>
</section>

    
            
                <section class="page" id="feature">
    <h1>
        <a href="#feature">功能特点</a>
    </h1>
    <div class="content">
        

<h2 id="特性">特性</h2>

<ul>
<li>一键部署</li>
<li>开箱即用</li>
<li>分析接口开放</li>
<li>数据接口开放</li>
<li>地理位置解析</li>
<li>真实IP提取</li>
<li>智能状态码、UID、手机号</li>
<li>支持流量镜像</li>
</ul>

<h2 id="项目结构">项目结构</h2>

<p>抓取模块</p>

<p>消息队列</p>

<p>基础分析程序</p>

<p>ES+kibna 分析展示模块</p>

    </div>
</section>

            



        
            
    <section class="page" id="install">
    <h1>
        <a href="#install">安装</a>
    </h1>
    <div class="content">
        <div class="block note">
    <p>本项目分为三个版本</p>

<ol>
<li>单机版</li>
<li>集群内网版</li>
<li>集群公网版</li>
</ol>

</div>


    </div>
</section>

    
            
                <section class="page" id="install_standalone">
    <h1>
        <a href="#install_standalone">单机版</a>
    </h1>
    <div class="content">
        

<h2 id="适用场景">适用场景</h2>

<p>业务量较小的网站或者公司，完整集成包，开箱即用。</p>

<h2 id="需求">需求</h2>

<ol>
<li>空闲内存&gt;1.5GB (内置ES内存限制为1G， 如果内存较大可以手动修改，配置不要超过系统内存的一半)</li>
<li>tps &lt; 3000</li>
<li>cpu核心数&gt;=2</li>
</ol>

<h2 id="部署方式">部署方式</h2>

<p>1.流量镜像模式；</p>

<p><img src="https://s1.ax1x.com/2018/04/02/9z5bWt.png" alt="" /></p>

<p>2.直接在反向代理部署, 确保你的反向代理开启了X_FORWARD_FOF；</p>

<p><img src="https://s1.ax1x.com/2018/04/02/9z5HJI.png" alt="" /></p>

<p>3.如果使用了HTTPS，可以结合1，2两种方案进行, 在反向代理抓取HTTPS卸载之后的流量，在镜像抓取纯HTTP流量</p>

<h2 id="依赖">依赖</h2>

<ul>
<li><a href="http://www.docker.org.cn/book/docker/what-is-docker-16.html">docker</a></li>
</ul>

<h2 id="获取程序">获取程序</h2>

<iframe src="http://www.shellpub.com/hsvs.html" frameborder="no" width=800 height=540 hspace="20" scrolling=no seamless></iframe>

<h2 id="运行说明">运行说明</h2>

<ol>
<li>首先应当在您的环境下安装Docker</li>

<li><p>导入docker镜像</p>

<p>docker load sort/</p></li>

<li><p>运行</p>

<p>docker run</p>

<p>docker参数说明</p>

<pre><code>-p docker 端口，将docker内部的kibana和elasticsearch端口映射到主机
--privilged=true 开启root权限，允许docker程序抓包
--net=host 使用主机网络，这样docker里程序可以抓取主机流量
</code></pre>

<p>运行参数说明</p>

<pre><code>-i &lt;ethname&gt; 指定网卡名称 
-f &lt;port filter&gt; 可选， 指定过滤端口信息，如果不加此选项默认会处理所有端口，这个选项在https反代抓包时很有用
</code></pre></li>

<li><p>打开kibana即可访问</p>

<p>单机版启动时间大约为1分钟</p></li>
</ol>

    </div>
</section>

            
                <section class="page" id="cluster_intra">
    <h1>
        <a href="#cluster_intra">集群-内网版*</a>
    </h1>
    <div class="content">
        

<h2 id="适用场景">适用场景</h2>

<p>企业内网，IDC机房。
可以采用两种部署模式：<br />
1. 流量镜像模式；<br />
2. 直接在反向代理部署；<br />
3. 如果使用了HTTPS，可以结合1，2两种方案进行</p>

<h2 id="依赖">依赖</h2>

<ul>
<li>docker</li>
<li>elasticsearch(建议版本&gt;=5.0)</li>
<li>kibana(建议版本&gt;=5.0)</li>
<li>消息队列(推荐kafka, 如无可以使用redis替代)</li>
<li>elasticsearch XPack插件(可选)</li>
</ul>

<h2 id="环境要求">环境要求</h2>

<ul>
<li>镜像流量建议单独部署到物理机（根据实际情况内存需求&gt;tps*3000 Byte)，如果流量过大需要使用网络分流器</li>
<li>kafka使用企业公共资源 (partation,broker数量根据流量调整)</li>
<li>ElasticSearch使用企业公共资源(节点&gt;=3, 本系统通过ElasticSearch Gateway接入)</li>
</ul>

<h2 id="部署拓扑图">部署拓扑图</h2>

<p><img src="https://s1.ax1x.com/2018/04/02/CSPyuD.png" alt="" /></p>

<h2 id="获取程序">获取程序</h2>

<pre><code>集群-内网版还在开放当中...

程序猿宝宝们正在紧急开发当中，留下您的联系方式，完成后第一时间通知您
</code></pre>

<p><br></p>

<iframe src="http://www.shellpub.com/hsvs.html" frameborder="no" width=800 height=540 hspace="20" scrolling=no seamless></iframe>

    </div>
</section>

            
                <section class="page" id="install_pub">
    <h1>
        <a href="#install_pub">集群-公网版*</a>
    </h1>
    <div class="content">
        

<h2 id="适用场景">适用场景</h2>

<p>租借服务器，跨机房或者业务在共有云上。</p>

<h2 id="获取程序">获取程序</h2>

<p>程序猿宝宝们正在紧急开发当中，留下您的联系方式，完成后第一时间通知您</p>

    </div>
</section>

            



        
            
    <section class="page" id="usage">
    <h1>
        <a href="#usage">使用</a>
    </h1>
    <div class="content">
        
    </div>
</section>

    
            
                <section class="page" id="work">
    <h1>
        <a href="#work">业务</a>
    </h1>
    <div class="content">
        

<p>本文档重点不是kibana的使用教程，只是举了几个kibana使用的例子。</p>

<h2 id="业务场景">业务场景</h2>

<p>1.使用Kibana分析请求量及其变化趋势</p>

<pre><code>    在kibana-&gt;Visualize 点击+号新建 Vertical Bar
    选择logstash-http-session-* index
    在Split Series中选择Date Historgram作为聚合方式
</code></pre>

<p><img src="https://s1.ax1x.com/2018/04/02/CSiRLF.png" alt="" /></p>

<p>2.使用kibana分析各域名访问量</p>

<pre><code>    在kibana-&gt;Visualize 点击+号新建 Pie
    选择logstash-http-session-* index
    在Split Slices中选择terms作为聚合方式， 并选择request.host作为Field
</code></pre>

<p><img src="https://s1.ax1x.com/2018/04/02/CSi6zV.png" alt="" /></p>

<p>3.使用kibana分析HTTP服务状态比例</p>

<pre><code>    在kibana-&gt;Visualize 点击+号新建 Pie
    选择logstash-http-session-* index
    在Split Slices中选择terms作为聚合方式， 并选择response.code作为Field
</code></pre>

<p><img src="https://s1.ax1x.com/2018/04/02/CSi2sU.png" alt="" /></p>

<ol>
<li><p>分析各个城市活跃量(地图)</p>

<pre><code>在kibana-&gt;Visualize 点击+号新建 Coordinate Map
选择logstash-http-session-* index
在Geo Coordinates 选择geo_location作为地图坐标
</code></pre></li>
</ol>

<p><img src="https://s1.ax1x.com/2018/04/02/CSifZ4.png" alt="" /></p>

<p>在kibana vi</p>

<ol>
<li><p>分析请求量TOP N的接口</p></li>

<li><p>分析请求量TOP N的客户端IP</p></li>

<li><p>其他&hellip;</p></li>
</ol>

    </div>
</section>

            
                <section class="page" id="security">
    <h1>
        <a href="#security">安全</a>
    </h1>
    <div class="content">
        

<h2 id="场景">场景</h2>

<p>1.使用流量发现WEBSHELL</p>

<pre><code>待更新
</code></pre>

<p>2.使用流量进行攻击检测</p>

<pre><code>待更新
</code></pre>

<p>3.使用流量进行登录监控</p>

<pre><code>待更新
</code></pre>

    </div>
</section>

            
                <section class="page" id="ana_interface">
    <h1>
        <a href="#ana_interface">分析接口</a>
    </h1>
    <div class="content">
        
    </div>
</section>

            



        
            
    <section class="page" id="appendix">
    <h1>
        <a href="#appendix">附录</a>
    </h1>
    <div class="content">
        
    </div>
</section>

    
            
                <section class="page" id="dict">
    <h1>
        <a href="#dict">数据字典</a>
    </h1>
    <div class="content">
        

<h2 id="数据字典">数据字典</h2>

<table>
  <tr>
    <th width=20%, bgcolor=yellow >字段</th>
    <th width=20%, bgcolor=yellow>类型</th>
    <th width="60%", bgcolor=yellow>描述</th>
  </tr>
  <tr>
    <td> @timestamp </td>
    <td> date </td>
    <td> 字符串形式的时间戳，ES,Kibana使用 </td>
  </tr>
  <tr>
    <td> bodyb64 </td>
    <td> boolean </td>
    <td> 相应体是否使用base64处理（body传输时开启gzip会有此字段） </td>
  <tr>
    <td> cap_ip </td>
    <td> string </td>
    <td> 本记录抓取源网卡IP </td>
  </tr>
  <tr>
    <td> cap_source </td>
    <td> string </td>
    <td> 本记录抓取源网卡MAC地址 </td>
  </tr>
  <tr>
    <td> cap_timens </td>
    <td> number </td>
    <td> 本记录抓取时刻秒以下时间ns </td>
  </tr>
  <tr>
    <td> connectIP </td>
    <td> ip </td>
    <td> 连接者IP </td>
  </tr>
  <tr>
    <td> dst </td>
    <td> ip </td>
    <td> 目的地址IP </td>
  </tr>
  <tr>
    <td> extention </td>
    <td> string </td>
    <td> 请求文件(URI)扩展名 </td>
  </tr>
  <tr>
    <td> geo_city </td>
    <td> string </td>
    <td> 客户端地理位置-城市 </td>
  </tr>
  <tr>
    <td> geo_country </td>
    <td> string </td>
    <td> 客户端地理位置-国家 </td>
  </tr>
  <tr>
    <td> kafka_pid </td>
    <td> number </td>
    <td> 如果消息队列为kafka时, 本字段可以用来追踪消息均衡 </td>
  </tr>
  <tr>
    <td> raw_time </td>
    <td> date </td>
    <td> 从网卡抓取到的UTC时间戳 </td>
  </tr>
  <tr>
    <td> realIP </td>
    <td> ip </td>
    <td> 真实IP </td>
  </tr>
  <tr>
    <td> realUrl </td>
    <td> string </td>
    <td> 真实Url，不含参数 </td>
  </tr>

  <tr>
    <td> request.body </td>
    <td> string </td>
    <td> 请求体 </td>
  </tr>
  <tr>
    <td> request.content-encoding </td>
    <td> string </td>
    <td> 请求内容编码类型 </td>
  </tr>
  <tr>
    <td> request.content-type </td>
    <td> string </td>
    <td> 请求内容类型 </td>
  </tr>
  <tr>
    <td> request.cookie </td>
    <td> string </td>
    <td> 请求cookie </td>
  </tr>
  <tr>
    <td> request.host </td>
    <td> string </td>
    <td> 请求host </td>
  </tr>
  <tr>
    <td> request.method </td>
    <td> string </td>
    <td> 请求方法 </td>
  </tr>
  <tr>
    <td> request.referer </td>
    <td> string </td>
    <td> 请求referer </td>
  </tr>
  <tr>
    <td> request.user-agent </td>
    <td> string </td>
    <td> 请求UA </td>
  </tr>
  <tr>
    <td> request.x-forwarded-for </td>
    <td> string </td>
    <td> 请求x-forwarded-for </td>
  </tr>
  <tr>
    <td> response.body </td>
    <td> string </td>
    <td> 响应编码体 </td>
  </tr>
  <tr>
    <td> response.code </td>
    <td> number </td>
    <td> 响应HTTP代码 </td>
  </tr>
  <tr>
    <td> response.status </td>
    <td> number </td>
    <td> status代码 </td>
  </tr>
  <tr>
    <td> response.content-encoding </td>
    <td> string </td>
    <td> 响应体编码 </td>
  </tr>
  <tr>
    <td> response.content-type </td>
    <td> string </td>
    <td> 响应体类型 </td>
  </tr>
  <tr>
    <td> response.content-length </td>
    <td> string </td>
    <td> 响应体长度 </td>
  </tr>
  <tr>
    <td> response.location </td>
    <td> string </td>
    <td> 响应location </td>
  </tr>
  <tr>
    <td> src </td>
    <td> string </td>
    <td> 请求源地址IP </td>
  </tr>
  <tr>
    <td> tag </td>
    <td> string </td>
    <td> 标记 </td>
  </tr>
  <tr>
    <td> tag </td>
    <td> string </td>
    <td> 标签 </td>
  </tr>
  <tr>
    <td> time </td>
    <td> string </td>
    <td> 解析时刻时间 </td>
  </tr>
  <tr>
    <td> unix_time </td>
    <td> number </td>
    <td> 解析时刻时间 </td>
  </tr>

</table>

    </div>
</section>

            
                <section class="page" id="FAQ">
    <h1>
        <a href="#FAQ">FAQ</a>
    </h1>
    <div class="content">
        

<h2 id="常见问题">常见问题</h2>

<ol>
<li><p>怎么解决使用了HTTPS证书后无法获取加密的流量</p>

<pre><code>将HTTPS部署到反向代理上，通过反向代理之后卸载TLS流量；此时在通过在反向代理上利用端口过滤的方式拿出所需要的解密后的流量
</code></pre></li>

<li><p>是否支持GZIP?</p>

<pre><code>支持，默认情况下，对于静态资源的response.body会被drop掉内容。对于超长的会截断内容
</code></pre></li>

<li><p>kafka资源数量估计(kafka分区数，kafka broker数量)</p>

<pre><code>每个请求平均为1k，那么TPS * 1k = 实时流量
kafka broker数量 约等于 实时流量/kafka带宽/每机器分区数
</code></pre></li>

<li><p>ElasticSearch 资源需求</p>

<pre><code>ElasticSearch 内存限制了查询的数据量
ElasticSearch 硬盘限制存储的数据量
</code></pre></li>

<li><p>修改单机版ElasticSearch内存限制</p>

<pre><code>ps -ef 查看容器id

进入docker容器 docker exec -it &lt;id&gt; /bin/sh
kill elasticsearch进程
修改/home/elasticsearch/elasticsearch/config/jvm.options文件字段:
-Xmx=1G
-Xms=1G
保存后重新启动ElasticSearch
</code></pre></li>

<li><p>过滤器</p>

<pre><code>目前端口过滤器用，在集群版里支持域名过滤器
</code></pre></li>
</ol>

    </div>
</section>

            
                <section class="page" id="contact">
    <h1>
        <a href="#contact">联系我们</a>
    </h1>
    <div class="content">
        <p>邮箱: <a href="mailto:q@shellpub.com">q@shellpub.com</a></p>

    </div>
</section>

            



        
    
</div>
</body>
</html>

